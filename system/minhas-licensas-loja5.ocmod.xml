<?xml version="1.0" encoding="utf-8"?>
<modification>
<name>Minhas Licenças [Loja5]</name>
<version>1.0</version>
<author>Loja5.com.br - suportedaloja@gmail.com</author>
<code>minhas-licencas-loja5</code>
<description></description>

<file path="admin/controller/common/dashboard.php">
<operation>
<notes></notes>
<search index="" regex="false" trim="false"><![CDATA[public function index() {]]></search>
<add offset="0" trim="false" position="before"><![CDATA[
public function buscar_licencas_loja5(){
	//busca as licenças
	$sql = "SELECT * FROM `" . DB_PREFIX . "setting` WHERE `key` LIKE '%_serial' AND `value` <> '' GROUP BY `code`";
	$instaladas = $this->db->query($sql);
	$validas = array();
	foreach($instaladas->rows as $licenca){
		if (preg_match('/^\d+-\d+-\d+-\d+-\w+$|^\d+-\d+-\d+-\d+-\w+-\w+$/', $licenca['value'])){
			$validas[] = trim($licenca['value']);
		}
	}
	//somente consulta se existir licenças validas
	$json = array();
	if(count($validas) > 0){
		//curl
		$dados = json_encode($validas);
		$service_url = 'https://www.loja5.com.br/index.php?route=module/iono/buscar';
		$curl = curl_init($service_url);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);  
		curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE); 
		curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 10);
		curl_setopt($curl, CURLOPT_HTTPHEADER, array(
			'Content-Type: application/json',
			'Content-Length: ' .strlen($dados))
		); 
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($curl, CURLOPT_POST, true);
		curl_setopt($curl, CURLOPT_POSTFIELDS, $dados);
		$json = curl_exec($curl);
		$curlErrno     = curl_errno($curl);
		$curlErr       = curl_error($curl);
		curl_close($curl);
	}
	$this->response->addHeader('Content-Type: application/json');
	$this->response->setOutput($json);
}
]]></add>
</operation>
</file>

<file path="admin/view/template/common/dashboard.twig">
<operation>
<notes></notes>
<search index="0" regex="false" trim="false"><![CDATA[{{ footer }}]]></search>
<add offset="0" trim="false" position="before"><![CDATA[
<!-- verificador de atualizações loja5.com.br -->
<script>
$( document ).ready(function() {
	$.getJSON( "index.php?route=common/dashboard/buscar_licencas_loja5&user_token={{ user_token }}", function( data ) {
		console.log(data);
		if (typeof data.atualizados !== 'undefined') {
			var alerta = '';
			$.each( data.atualizados, function( key, val ) {
				alerta += '<div class="alert alert-info"><i class="fa fa-exclamation-circle"></i> O seu m&oacute;dulo <b>'+val.modulo+'</b> foi atualizado na <b>Loja5.com.br</b>, <a href="https://www.loja5.com.br/account/download.html" target="_blank">acesse sua conta</a> e baixe o mesmo at&eacute; <b>'+val.validade+'</b>.</div>';
			});
			$(alerta).appendTo( $("#content .container-fluid").first() );
		}
	});
});
</script>
<!-- verificador de atualizações loja5.com.br -->
]]></add>
</operation>
</file>

<file path="admin\view\template\common\dashboard.tpl">
<operation>
<notes></notes>
<search index="0" regex="false" trim="false"><![CDATA[<?php echo $footer; ?>]]></search>
<add offset="0" trim="false" position="before"><![CDATA[
<!-- verificador de atualizações loja5.com.br -->
<script>
$( document ).ready(function() {
	$.getJSON( "index.php?route=common/dashboard/buscar_licencas_loja5&user_token=<?php echo $user_token;?>", function( data ) {
		console.log(data);
		if (typeof data.atualizados !== 'undefined') {
			var alerta = '';
			$.each( data.atualizados, function( key, val ) {
				alerta += '<div class="alert alert-info"><i class="fa fa-exclamation-circle"></i> O seu m&oacute;dulo <b>'+val.modulo+'</b> foi atualizado na <b>Loja5.com.br</b>, <a href="https://www.loja5.com.br/account/download.html" target="_blank">acesse sua conta</a> e baixe o mesmo at&eacute; <b>'+val.validade+'</b>.</div>';
			});
			$(alerta).appendTo( ".container-fluid" );
		}
	});
});
</script>
<!-- verificador de atualizações loja5.com.br -->
]]></add>
</operation>
</file>

</modification>
